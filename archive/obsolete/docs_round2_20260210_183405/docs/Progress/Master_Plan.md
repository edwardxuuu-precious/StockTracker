# StockTracker 总体规划

## 📋 目标体系

### 总目标
**构建一个稳定、可靠、易用的股票投资组合管理系统**

### 目标分解树

```
总目标: StockTracker系统
├── Goal#1: 基础设施建设 ✅
│   ├── 前端框架搭建
│   ├── 后端框架搭建
│   ├── 进程管理系统
│   └── 配置验证系统
│
├── Goal#2: 投资组合管理
│   ├── CRUD功能
│   ├── 数据验证
│   ├── 状态管理
│   └── 界面优化
│
├── Goal#3: 持仓管理
│   ├── 买入卖出
│   ├── 持仓追踪
│   ├── 成本计算
│   └── 收益分析
│
├── Goal#4: 实时行情
│   ├── 数据源接入
│   ├── 行情获取
│   ├── 数据缓存
│   └── 批量查询
│
├── Goal#5: 数据分析
│   ├── 收益计算
│   ├── 风险评估
│   ├── 可视化图表
│   └── 报表生成
│
├── Goal#6: 策略回测
│   ├── 回测引擎
│   ├── 策略定义
│   ├── 结果分析
│   └── 性能指标
│
├── Goal#7: AI助手
│   ├── OpenAI集成
│   ├── 投资建议
│   ├── 市场分析
│   └── 问答交互
│
└── Goal#8: 部署运维
    ├── 容器化
    ├── CI/CD
    ├── 监控告警
    └── 备份恢复
```

## 🧭 技术路线（2026-02-09）

### 1) 数据层（本地数据积累 + 可插拔数据源）
- 统一标的与市场元数据（股票、交易所、货币等）
- 分钟线/日线 Bar 统一存储模型（本地持久化）
- 数据源适配器接口：支持替换、扩展与全量回填
- 中国市场：AKShare 分钟级实时 + 历史回填
- 美股市场：收盘后更新最新分钟级数据（非盘中实时）
- 数据质量校验与回填日志

### 2) 回测内核（自研）
- 使用本地数据驱动回测（禁止模拟价格）
- 订单/撮合/资金/持仓/费用/滑点/交易日历
- 支持个股与组合回测、可复现与可解释输出
- 回测结果指标与报告结构标准化

### 3) 策略脚本与任务管理
- 策略脚本以 Python 为主，可保存、版本化与复用
- 参数 schema 与可追踪的回测任务记录
- 任务复跑与结果对比

### 4) 知识库与 Agent
- 资料入库支持 PDF / TXT / JSON
- 混合检索（关键词 + 向量 + 重排序）与证据链
- 参数调优与可视化报告生成

### 5) 前端与可视化
- 数据健康状态、策略版本视图、回测结果对比
- 报告导出与复盘记录

## 🎯 各目标详细规划

## Goal#1: 基础设施建设 ✅

### 目标描述
搭建稳定可靠的开发基础设施,包括前后端框架、进程管理、配置验证等。

### 任务拆解

#### 1.1 前端框架搭建 ✅
**任务内容:**
- 初始化Vite + React项目
- 配置React Router路由
- 集成Tailwind CSS
- 配置Axios HTTP客户端
- 集成Zustand状态管理

**完成标准:**
- ✅ 项目可正常启动
- ✅ 路由跳转正常
- ✅ 样式渲染正确
- ✅ API调用成功
- ✅ 状态管理工作

**测评方式:**
```bash
cd frontend
npm install
npm run dev
# 访问 http://localhost:5173
# 检查页面是否正常显示
# 检查路由是否可切换
# 检查开发者工具无错误
```

#### 1.2 后端框架搭建 ✅
**任务内容:**
- 初始化FastAPI项目
- 配置SQLAlchemy ORM
- 设计数据库模型
- 实现基础API端点
- 配置CORS中间件

**完成标准:**
- ✅ 服务器可正常启动
- ✅ 数据库连接成功
- ✅ API文档可访问
- ✅ CORS配置正确
- ✅ 基础端点响应

**测评方式:**
```bash
cd backend
python -m uvicorn app.main:app --reload
# 访问 http://localhost:8001/docs
# 测试API端点
curl http://localhost:8001/api/v1/portfolios/
# 应返回JSON数据
```

### 1) 数据层（本地数据积累 + 可插拔数据源）
- 统一标的与市场元数据（股票、交易所、货币等）
- 分钟线/日线 Bar 统一存储模型（本地持久化）
- 数据源适配器接口：支持替换、扩展与全量回填
- 中国市场：AKShare 分钟级实时 + 历史回填
- 美股市场：收盘后更新最新分钟级数据（非盘中实时）
- 数据质量校验与回填日志

### 2) 回测内核（自研）
- 使用本地数据驱动回测（禁止模拟价格）
- 订单/撮合/资金/持仓/费用/滑点/交易日历
- 支持个股与组合回测、可复现与可解释输出
- 回测结果指标与报告结构标准化

### 3) 策略脚本与任务管理
- 策略脚本以 Python 为主，可保存、版本化与复用
- 参数 schema 与可追踪的回测任务记录
- 任务复跑与结果对比

### 4) 知识库与 Agent
- 资料入库支持 PDF / TXT / JSON
- 混合检索（关键词 + 向量 + 重排序）与证据链
- 参数调优与可视化报告生成

### 5) 前端与可视化
- 数据健康状态、策略版本视图、回测结果对比
- 报告导出与复盘记录

## Goal#4: 市场数据与本地数据层

### 目标描述
建立可插拔的数据源与本地数据积累体系，支持中国市场分钟级实时与美股收盘后分钟级更新。
### 任务拆解

#### 4.1 数据源适配与抽象
**任务内容:**
- 设计统一数据源接口（历史/增量/最新）
- 接入 AKShare（A股分钟级实时）
- 预留美股分钟数据源适配器（收盘后更新）
- 数据源切换与回填能力

**完成标准:**
- 数据源可插拔并支持全量回填
- A股分钟级实时可用
- 美股收盘后分钟级更新可用

#### 4.2 本地存储与回填
**任务内容:**
- 建立本地 Bar 数据模型（1m/1d）
- 实现全量回填与增量更新
- 数据质量校验与回填日志

**完成标准:**
- 数据可落地并可查询
- 回填流程稳定可复跑

#### 4.3 数据服务 API
**任务内容:**
- 提供本地数据查询 API
- 提供数据健康/回填状态接口

**完成标准:**
- 回测与前端统一使用本地数据读取
- 可快速定位数据缺口与异常

## Goal#5: 数据分析

### 目标描述
提供投资组合和持仓的收益分析和可视化。

### 任务拆解

#### 5.1 收益计算
**任务内容:**
- 计算组合总收益
- 计算已实现收益
- 计算未实现收益
- 计算收益率
- 计算持仓占比

**完成标准:**
- ✅ 计算逻辑正确
- ✅ 精度满足要求
- ✅ 性能可接受
- ✅ API响应正常

**测评方式:**
```
验证场景:
1. 初始资金: 100000
2. 买入AAPL: 100股 @ 150
3. 买入MSFT: 50股 @ 300
4. 卖出AAPL: 50股 @ 160

计算验证:
- 总成本 = 15000 + 15000 = 30000
- 当前市值 = 50*160 + 50*300 = 23000
- 现金余额 = 100000 - 15000 - 15000 + 8000 = 78000
- 总资产 = 23000 + 78000 = 101000
- 总收益 = 101000 - 100000 = 1000
- 总收益率 = 1000 / 100000 = 1%
- 已实现收益 = (160-150)*50 = 500
- 未实现收益 = 23000 - 22500 = 500
```

#### 5.2 可视化图表
**任务内容:**
- 实现收益趋势图
- 实现持仓分布饼图
- 实现收益柱状图
- 实现价格K线图

**完成标准:**
- ✅ 图表渲染正常
- ✅ 数据准确无误
- ✅ 交互体验良好
- ✅ 响应式适配

**测评方式:**
```
1. 收益趋势图
   - X轴显示时间
   - Y轴显示收益
   - 鼠标悬停显示详情
   - 可缩放和平移

2. 持仓分布
   - 显示各股票占比
   - 颜色区分不同股票
   - 点击显示详情

3. 收益对比
   - 对比不同时期收益
   - 柱状图显示
   - 支持多个组合对比
```

#### 5.3 报表生成
**任务内容:**
- 实现收益报表
- 实现交易报表
- 实现持仓报表
- 支持导出PDF/Excel

**完成标准:**
- ✅ 报表数据完整
- ✅ 格式美观规范
- ✅ 导出功能正常
- ✅ 支持多种格式

**测评方式:**
```
1. 生成收益报表
   - 选择时间范围
   - 选择组合
   - 点击生成
   - 预览报表
   - 导出Excel

2. 验证数据
   - 总收益与计算一致
   - 明细记录完整
   - 汇总数据准确
```

## Goal#6: 策略回测（自研内核）

### 目标描述
基于本地数据建立自研回测内核，支持个股与组合回测，保证可复现与可解释。
### 任务拆解

#### 6.1 回测内核
**任务内容:**
- 事件驱动或向量化执行引擎
- 订单/撮合/资金/持仓/费用/滑点
- 交易日历与时间对齐

**完成标准:**
- 可稳定执行回测并输出标准结果
- 结果可复现

#### 6.2 策略脚本规范
**任务内容:**
- Python 策略脚本接口与模板
- 参数 schema 与版本记录

**完成标准:**
- 策略可保存/复用
- 参数可追踪

#### 6.3 结果分析与复盘
**任务内容:**
- 收益/回撤/胜率等指标
- 交易明细与可视化报告

**完成标准:**
- 结果指标齐全
- 支持多策略对比

## Goal#7: AI助手

### 目标描述
集成OpenAI API,提供智能投资建议和市场分析。

### 任务拆解

#### 7.1 OpenAI集成
**任务内容:**
- 配置OpenAI API
- 实现对话接口
- 实现上下文管理
- 实现流式响应
- 错误处理

**完成标准:**
- ✅ API调用成功
- ✅ 对话流畅
- ✅ 上下文连贯
- ✅ 流式输出工作
- ✅ 错误友好提示

**测评方式:**
```bash
# 测试对话
curl -X POST http://localhost:8001/api/v1/ai/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"分析一下AAPL的投资价值"}'

# 应返回:
# {
#   "response": "Apple公司是...",
#   "conversation_id": "xxx"
# }

# 测试上下文
curl -X POST http://localhost:8001/api/v1/ai/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"它的PE是多少","conversation_id":"xxx"}'

# 应返回与上一轮对话相关的回复
```

#### 7.2 投资建议
**任务内容:**
- 实现持仓分析
- 实现风险评估
- 生成投资建议
- 市场情绪分析

**完成标准:**
- ✅ 分析维度全面
- ✅ 建议具体可行
- ✅ 风险提示明确
- ✅ 情绪判断准确

**测评方式:**
```
输入:
- 持仓数据
- 收益情况
- 市场行情

输出应包含:
- 持仓分析(集中度、风险)
- 个股建议(买入/持有/卖出)
- 资产配置建议
- 风险提示
- 市场观点
```

#### 7.3 前端界面
**任务内容:**
- 实现对话界面
- 实现消息展示
- 实现打字动画
- 实现历史记录
- 实现建议卡片

**完成标准:**
- ✅ 界面美观友好
- ✅ 对话流畅
- ✅ 动画自然
- ✅ 历史可查询
- ✅ 建议可操作

**测评方式:**
```
1. 打开AI助手
   - 显示欢迎消息
   - 显示示例问题

2. 发送消息
   - 输入框输入
   - 发送按钮或回车
   - 消息立即显示
   - AI回复流式显示

3. 查看历史
   - 显示所有对话
   - 可滚动查看
   - 可清空历史
```

## Goal#8: 部署运维

### 目标描述
容器化部署,实现CI/CD,建立监控告警体系。

### 任务拆解

#### 8.1 Docker容器化
**任务内容:**
- 编写前端Dockerfile
- 编写后端Dockerfile
- 编写docker-compose
- 配置环境变量
- 优化镜像大小

**完成标准:**
- ✅ 镜像构建成功
- ✅ 容器正常运行
- ✅ 服务互联互通
- ✅ 数据持久化
- ✅ 镜像体积合理

**测评方式:**
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 验证前端
curl http://localhost

# 验证后端
curl http://localhost/api/v1/portfolios/

# 检查日志
docker-compose logs

# 停止服务
docker-compose down
```

#### 8.2 CI/CD流程
**任务内容:**
- 配置GitHub Actions
- 自动化测试
- 自动化构建
- 自动化部署
- 回滚机制

**完成标准:**
- ✅ 提交触发CI
- ✅ 测试自动运行
- ✅ 构建自动进行
- ✅ 部署自动完成
- ✅ 失败可回滚

**测评方式:**
```yaml
# .github/workflows/ci.yml
name: CI/CD
on: [push]
jobs:
  test:
    - 运行单元测试
    - 运行集成测试
  build:
    - 构建前端
    - 构建后端
    - 推送镜像
  deploy:
    - 部署到测试环境
    - 运行冒烟测试
    - 部署到生产环境
```

#### 8.3 监控告警
**任务内容:**
- 集成Prometheus
- 配置Grafana
- 设置告警规则
- 日志收集
- 错误追踪

**完成标准:**
- ✅ 指标采集正常
- ✅ 仪表盘可视化
- ✅ 告警及时触发
- ✅ 日志可查询
- ✅ 错误可追溯

**测评方式:**
```
1. 监控指标
   - CPU使用率
   - 内存使用率
   - 请求QPS
   - 响应时间
   - 错误率

2. 告警规则
   - CPU > 80% 持续5分钟
   - 内存 > 90%
   - 错误率 > 1%
   - 服务不可用

3. 验证告警
   - 模拟高负载
   - 检查是否收到告警
   - 验证告警内容
```

## 📊 总体时间规划

### Phase 1: 基础设施 (已完成) ✅
- 时间: 已完成
- 目标: Goal#1
- 里程碑: 前后端可正常运行

### Phase 2: 核心功能 (进行中)
- 时间: 2-4周
- 目标: Goal#2, Goal#3, Goal#4
- 里程碑: 投资组合和持仓管理完整可用

### Phase 3: 数据分析 (计划中)
- 时间: 2-3周
- 目标: Goal#5
- 里程碑: 收益分析和可视化完成

### Phase 4: 高级功能 (计划中)
- 时间: 3-4周
- 目标: Goal#6, Goal#7
- 里程碑: 回测和AI助手可用

### Phase 5: 部署上线 (计划中)
- 时间: 1-2周
- 目标: Goal#8
- 里程碑: 系统可生产环境部署

---

**最后更新:** 2026-02-09
**版本:** 1.0
**状态:** 进行中
